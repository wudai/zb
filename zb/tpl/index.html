<{include file="section/header.html"}>
<{cssholder}>
/bootstrap/datepicker/css/datepicker.css
<{/cssholder}>
<{jsholder}>
/bootstrap/datepicker/js/bootstrap-datepicker.js
<{/jsholder}>
<div class="container row-fluid">
	<div class="span7 offset1 form_input">
		<ul class="inline title">
			<li>记录消费</li>
			<li><a href="/index.php?act=income">记录收入</a></li>
			<li><a href="/index.php?app=bill&act=dinner">记录聚餐</a></li>
		</ul>
		<form action="/index.php?app=bill&act=expense" method="post" class="form-horizontal">
		<div class="control-group">
			<label class="control-label">时间</label>
			<div class="controls"><input type="text" name="bill_date" value="<{if $smarty.get.bill_date}><{$smarty.get.bill_date}><{else}><{$smarty.now|date_format:"%Y-%m-%d"}><{/if}>" /></div>
		</div>
		<div class="control-group">
			<label class="control-label">地点</label>
			<div class="controls"><input type="text" name="position_name" autocomplete="off" /></div>
			<input type="hidden" name="position_id" />
		</div>
		<div class="control-group">
			<label class="control-label">金额</label>
			<div class="controls"><input type="text" name="amount" /></div>
		</div>
		<div class="control-group">
			<div class="controls">
				<small><a href="javascript:;" class="ac_expense_detail">+添加消费明细</a></small>
			</div>
		</div>
		<div class="control-group hidden acc_group">
			<label class="control-label">支付账号</label>
			<div class="controls">
				<select name="account_id" class="inline"><{html_options options=$account_options}></select>
				<select name="inter_mediate" class="inline"><option value="">通过什么账号</option><{html_options options=$account_options}></select>
				<{*<a href="">组合支付</a>*}>
			</div>
		</div>
		<div class="control-group hidden comment_group">
			<label class="control-label">事件</label>
			<div class="controls"><input type="text" name="comment"></div>
		</div>
		<div class="control-group hidden more_item">
			<div class="controls"><small><a href="javascript:;" class="ac_add_item">+添加项目</a></small></div>
		</div>
		<div class="control-group">
			<div class="controls">
				<button type="submit" class="btn btn-primary" data-loading-text="保存中……">添加</button><button type="reset" class="btn btn-link ac_clear"><small>取消</small></button>
			</div>
		</div>
		</form>
	</div>
	<div class="span4"></div>
	</div>
	<div class="container row-fluid">
	<div class="span7 offset1"><h4>最近消费</h4></div>
	<div class="span4"></div>
	</div>
	<div class="container row-fluid">
	<div class="span7 offset1">
		<table class="table table-hover">
			<tbody>
				<{foreach $list as $line}>
				<tr class="ac_goto" srv="/index.php?app=event&act=detail&id=<{$line.event_id}>">
					<td><{$line.event_date}></td>
					<td><{$line.position_name}><{if $line.ex}>
						<small><{foreach $line.ex as $ex}><{$ex.expense_name}><{if !$ex@last}>、<{/if}><{/foreach}><{if $line.ex_more}>等<{/if}></small>
						<{/if}></td>
					<td><{$line.amount|money}>元</td>
					<td><a href="javascript:;"><i class="icon-edit"></i></a>&nbsp;<a href="javascript:;"><i class="icon-trash"></i></a></td>
				</tr>
				<{/foreach}>
			</tbody>
		</table>
	</div>
	<div class="span4">
	</div>
</div>
<{scriptholder}>
<script>
$(function() {
	$('input[name=bill_date]').datepicker({format: 'yyyy-mm-dd'});
	$('input[name=position_name]').typeahead({
		minChars:2,
		source: function(request,response){
			$('input[name=position_id]').val('');
			$.ajax({
				url: '/index.php?app=position&act=ajax_get',
				dataType: 'json',
				data:{
					q : request,
				},
				success:function(data){
					if(data.data) {
						var resultList = Array();
						resultList = data.data.map(function (item) {
							var aItem = { id: item.id, value: item.value};
							return JSON.stringify(aItem);
						});
						return response(resultList);
					}
				},
			});
		},
		matcher: function (obj) {
			return true;
		},
		sorter: function (items) {          
			var beginswith = [], caseSensitive = [], caseInsensitive = [], item;
			while (aItem = items.shift()) {
				var item = JSON.parse(aItem);
				if (!item.value.toLowerCase().indexOf(this.query.toLowerCase())) beginswith.push(JSON.stringify(item));
				else if (item.value.indexOf(this.query)) caseSensitive.push(JSON.stringify(item));
				else caseInsensitive.push(JSON.stringify(item));
			}
			return beginswith.concat(caseSensitive, caseInsensitive)
		},
		highlighter: function (obj) {
			var item = JSON.parse(obj);
			var query = this.query.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g, '\\$&')
			return item.value.replace(new RegExp('(' + query + ')', 'ig'), function ($1, match) {
				return '<strong>' + match + '</strong>'
			})
		},
		updater: function (obj) {
			var item = JSON.parse(obj);
			$('input[name="position_id"]').val(item.id);
			return item.value;
		}
	});
	$.subscribe('click_expense_detail', function(ev){
		if ($('.acc_group').hasClass('hidden')) {
			$('.acc_group').removeClass('hidden');
			$('.comment_group').removeClass('hidden');
			$('.more_item').removeClass('hidden');
			$('.ac_expense_detail').html('-收起消费明细');
			var html = [];
			if ($('.item_group').length == 0) {
				html.push('<div class="control-group item_group"><div class="control-label">项目1</div><div class="controls controls-row">');
				html.push('<input name="item_name[]" placeholder="请输入消费项目" class="span4"/>');
				html.push('<input name="item_price[]" placeholder="请输入价格" class="span2" />');
				html.push('<select name="item_type[]" class="span2"><option value="0">消费类型</option><{foreach $expense_type_list as $type_id => $type_name}><option value="<{$type_id}>"><{$type_name}></option><{/foreach}></select></label>');
				html.push('<input name="item_comment[]" placeholder="备注" class="span3" />');
				html.push('&nbsp;<small><a href="javascript:;" class="ac_drop_detail">删除</a></small>');
				html.push('</div></div>');
			} else {
				$('.item_group').show();
			}
			$('.comment_group').after(html.join(''));
		} else {
			$('.acc_group').addClass('hidden');
			$('.comment_group').addClass('hidden');
			$('.ac_expense_detail').html('+添加消费明细');
			$('.item_group').hide();
			$('.more_item').addClass('hidden');
		}
	}).subscribe('click_drop_detail', function(ev){
		$(ev.target).closest('.control-group').remove();
		$('.item_group').each(function(index){
			$(this).children('.control-label').html('项目'+(index+1));
		});
	}).subscribe('click_add_item', function(ev){
		var index = $('.item_group').length+1;
		var html = [];
		html.push('<div class="control-group item_group"><div class="control-label">项目'+index+'</div><div class="controls controls-row">');
		html.push('<input name="item_name[]" placeholder="请输入消费项目" class="span4"/>');
		html.push('<input name="item_price[]" placeholder="请输入价格" class="span2" />');
		html.push('<select name="item_type[]" class="span2"><option value="0">消费类型</option><{foreach $expense_type_list as $type_id => $type_name}><option value="<{$type_id}>"><{$type_name}></option><{/foreach}></select></label>');
		html.push('<input name="item_comment[]" placeholder="备注" class="span3" />');
		html.push('&nbsp;<small><a href="javascript:;" class="ac_drop_detail">删除</a></small>');
		html.push('</div></div>');
		$('.more_item').before(html.join(''));
	}).subscribe('click_clear', function(ev){
		$('.item_group').remove();
	});
});
</script>
<{/scriptholder}>
<{include file="section/footer.html"}>
